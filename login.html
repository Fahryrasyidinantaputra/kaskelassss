<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kas Kelas UBP — Login</title>
  <link rel="icon" href="assets/logo.png" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Firebase v8 (harus sebelum firebase.js) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="firebase.js"></script>
</head>

<body class="bg">
  <header class="topbar">
    <div class="brand">
      <img src="assets/logo.png" alt="Logo" />
      <span>Kas Kelas UBP</span>
    </div>
  </header>

  <main class="center">
    <div class="card login-card">
      <h2>Masuk / Daftar</h2>
      <p class="muted">Dashboard kas kelas modern & real-time</p>

      <div class="tabs">
        <button class="tab active" data-tab="login">Login</button>
        <button class="tab" data-tab="signup">Daftar</button>
      </div>

      <!-- LOGIN -->
      <form id="loginForm" class="panel active">
        <label>Username</label>
        <input id="loginUser" placeholder="admin / username" />
        <label>Password</label>
        <input id="loginPass" type="password" placeholder="••••••" />
        <button type="button" class="btn primary" id="btnLogin">Masuk</button>
      </form>

      <!-- SIGN UP -->
      <form id="signupForm" class="panel">
        <label>Nama Lengkap</label>
        <input id="regNama" placeholder="Nama lengkap" />
        <label>Username</label>
        <input id="regUser" placeholder="username unik" />
        <label>Password</label>
        <input id="regPass" type="password" placeholder="min 4 karakter" />
        <button type="button" class="btn" id="btnSignup">Daftar Anggota</button>
      </form>
    </div>
  </main>

  <footer class="footer">© UBP — Kas Kelas</footer>

  <script>
    const toast = (icon, text) => Swal.fire({icon, text, timer:1400, showConfirmButton:false});

    // Tabs
    document.querySelectorAll('.tab').forEach(b=>{
      b.onclick=()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
        document.getElementById(b.dataset.tab==='login'?'loginForm':'signupForm').classList.add('active');
      };
    });

    // Seed admin jika belum ada
    db.ref('users/admin').once('value', s=>{
      if(!s.exists()){
        db.ref('users/admin').set({ nama:'Administrator', username:'admin', password:'12345', role:'admin', aktif:true });
      }
    });

    // LOGIN
    document.getElementById('btnLogin').onclick=()=>{
      const u = document.getElementById('loginUser').value.trim();
      const p = document.getElementById('loginPass').value.trim();
      if(!u||!p) return toast('warning','Lengkapi username & password');

      db.ref('users/'+u).once('value', snap=>{
        if(!snap.exists()) return toast('error','Username tidak ditemukan');
        const user = snap.val();
        if(user.password!==p) return toast('error','Password salah');
        if(user.aktif===false) return toast('error','Akun nonaktif');

        localStorage.setItem('activeUser', JSON.stringify(user));
        toast('success','Login berhasil');
        setTimeout(()=>location.href='index.html',350);
      });
    };

    // SIGNUP
    document.getElementById('btnSignup').onclick=()=>{
      const nama=document.getElementById('regNama').value.trim();
      const user=document.getElementById('regUser').value.trim();
      const pass=document.getElementById('regPass').value.trim();
      if(!nama||!user||!pass) return toast('warning','Lengkapi semua data');
      if(pass.length<4) return toast('warning','Password minimal 4 karakter');

      db.ref('users/'+user).once('value', s=>{
        if(s.exists()) return toast('error','Username sudah dipakai');
        db.ref('users/'+user).set({ nama, username:user, password:pass, role:'anggota', aktif:true })
        .then(()=>{ toast('success','Akun dibuat. Silakan login.'); document.querySelector('.tab[data-tab="login"]').click(); });
      });
    };
  </script>
</body>
</html>
