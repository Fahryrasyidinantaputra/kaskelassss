<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kas Kelas UBP ‚Äî Dashboard</title>
  <link rel="icon" href="assets/logo.png" />
  <link rel="stylesheet" href="style.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase (CDN) -->
  <script src="firebase.js"></script>

  <style>
    /* elemen kecil khusus halaman ini */
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:18px}
    .kpi h3{margin:0 0 4px;font-size:14px;color:#667085}
    .kpi .val{font-size:24px;font-weight:700;color:#0d6efd}
    .chart-wrap{position:relative;width:100%;height:280px}
    .header-flex{display:flex;align-items:center;gap:14px;justify-content:space-between;margin-bottom:18px}
    .user-pill{background:#eef4ff;color:#0d47a1;border-radius:999px;padding:8px 12px;font-weight:600}
    .section{display:none}.section.active{display:block}
    .two-col{display:grid;grid-template-columns:1.3fr .9fr;gap:18px}
    @media(max-width:900px){.grid-3,.two-col{grid-template-columns:1fr}}
    .muted{color:#6b7280;font-size:13px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .toolbar input{max-width:260px}
  </style>
</head>
<body>
  <!-- Guard: kalau belum login, redirect ke login.html -->
  <script>
    const __user = JSON.parse(localStorage.getItem('activeUser')||'null');
    if(!__user){ location.replace('login.html'); }
  </script>

  <!-- Sidebar -->
  <aside class="sidebar">
    <h2>Kas Kelas UBP</h2>
    <a class="navlink active" data-section="dashboard">üè† Dashboard</a>
    <a class="navlink" data-section="transaksi">üí∞ Transaksi</a>
    <a class="navlink" data-section="qris">üì± QRIS</a>
    <a class="navlink" data-section="laporan">üìä Laporan</a>
    <a class="navlink" data-section="aktivitas">üìã Aktivitas</a>

    <div class="logout-btn" onclick="logout()">Keluar</div>
  </aside>

  <main class="main">
    <div class="header-flex">
      <div>
        <h1 style="margin:0">Dashboard Kas Kelas</h1>
        <p class="muted" id="permNote">Anda login sebagai ‚Ä¶</p>
      </div>
      <div class="user-pill" id="userBadge">‚Äî</div>
    </div>

    <!-- DASHBOARD -->
    <section id="dashboard" class="section active">
      <div class="grid-3">
        <div class="card kpi">
          <h3>Saldo Saat Ini</h3>
          <div class="val" id="sumSaldo">Rp 0</div>
          <div class="muted">Saldo terkini dari semua transaksi</div>
        </div>
        <div class="card kpi">
          <h3>Pemasukan</h3>
          <div class="val" id="sumIn">Rp 0</div>
        </div>
        <div class="card kpi">
          <h3>Pengeluaran</h3>
          <div class="val" id="sumOut">Rp 0</div>
        </div>
      </div>

      <div class="two-col">
        <div class="card">
          <h3 style="margin-bottom:10px">Rasio Pemasukan vs Pengeluaran</h3>
          <div class="chart-wrap"><canvas id="miniChart"></canvas></div>
        </div>
        <div class="card">
          <h3 style="margin-bottom:10px">Tren Saldo</h3>
          <div class="chart-wrap" style="height:300px"><canvas id="trendChart"></canvas></div>
        </div>
      </div>
    </section>

    <!-- TRANSAKSI -->
    <section id="transaksi" class="section">
      <div class="card">
        <div class="header-flex">
          <h2 style="margin:0">Transaksi</h2>
          <div class="toolbar">
            <button id="btnExportXls" class="btn-secondary" type="button">Export Excel</button>
            <button id="btnExportPdf" class="btn-primary" type="button">Export PDF</button>
          </div>
        </div>

        <!-- Form tambah (admin only, otomatis disembunyikan untuk anggota) -->
        <div id="formTransaksi" class="grid-3" style="grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:12px">
          <input id="nama" placeholder="Nama" />
          <select id="tipe">
            <option value="pemasukan" selected>Pemasukan</option>
            <option value="pengeluaran">Pengeluaran</option>
          </select>
          <select id="kategori">
            <option>Kas Rutin</option><option>Donasi</option><option>QRIS</option><option>Lainnya</option>
          </select>
          <input id="keterangan" placeholder="Keterangan (opsional)" />
          <input id="jumlah" type="number" min="0" placeholder="Jumlah (Rp)" />
          <button class="btn-primary" type="button" onclick="tambahTransaksi()">Tambah</button>
        </div>

        <div class="table-container">
          <table class="table" id="tabelKas">
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Nama</th>
                <th>Tipe</th>
                <th>Kategori</th>
                <th>Keterangan</th>
                <th>Jumlah</th>
                <th id="aksiHead">Aksi</th>
              </tr>
            </thead>
            <tbody id="tabelKasBody"></tbody>
          </table>
        </div>

        <div id="totalKategori" style="margin-top:12px" class="muted"></div>
      </div>
    </section>

    <!-- QRIS -->
    <section id="qris" class="section">
      <div class="two-col">
        <div class="card">
          <h2 style="margin-top:0">Pembayaran via QRIS</h2>
          <p class="muted">Upload bukti (opsional) untuk mempercepat verifikasi admin.</p>
          <div class="grid-3" style="grid-template-columns:repeat(2,1fr);gap:10px">
            <input id="qrisNama" placeholder="Nama Pembayar" />
            <input id="qrisNominal" type="number" min="0" placeholder="Nominal (Rp)" />
            <input id="qrisKeterangan" placeholder="Keterangan (opsional)" style="grid-column:1/3" />
            <input id="qrisBukti" type="file" accept="image/*" style="grid-column:1/2" />
            <button class="btn-primary" type="button" onclick="ajukanQRIS()" style="grid-column:2/3">Saya Sudah Bayar</button>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px">Daftar Pembayaran Pending</h3>
          <div class="table-container">
            <table class="table" id="pendingTable">
              <thead>
                <tr>
                  <th>Nama</th>
                  <th>Nominal</th>
                  <th>Keterangan</th>
                  <th>Bukti</th>
                  <th>Status</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody id="pendingBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- LAPORAN -->
    <section id="laporan" class="section">
      <div class="card">
        <div class="header-flex">
          <h2 style="margin:0">Laporan</h2>
          <div class="toolbar">
            <button id="btnExportXls2" class="btn-secondary" type="button">Export Excel</button>
            <button id="btnExportPdf2" class="btn-primary" type="button">Export PDF</button>
          </div>
        </div>

        <div class="table-container">
          <table class="table" id="rekapTable">
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Nama</th>
                <th>Kategori</th>
                <th>Pemasukan</th>
                <th>Pengeluaran</th>
                <th>Saldo Hari Itu</th>
              </tr>
            </thead>
            <tbody id="rekapBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- AKTIVITAS -->
    <section id="aktivitas" class="section">
      <div class="card">
        <h2 style="margin-top:0">Aktivitas</h2>
        <div id="aktivitasList" class="muted" style="display:grid;gap:8px"></div>
      </div>
    </section>
  </main>

  <script src="script.js"></script>
</body>
</html>
